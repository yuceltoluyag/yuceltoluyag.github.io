{% if COMMENTS_ENABLED %}
<section class="comment-section mt-10">
    <h2 class="text-2xl font-bold mb-4 text-text-primary">Yorumlar</h2>

    <!-- Yorum Formu -->
    <div id="comment-form" class="mt-6">
        <div class="bg-site-card dark:bg-site-card-dark p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-4 text-text-primary dark:text-text-primary-dark">Yorum Yap</h3>
            <div class="mb-4">
                <label for="name" class="block text-sm font-medium mb-2 text-text-primary dark:text-text-primary-dark">
                    İsim
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark focus:border-transparent" />
            </div>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium mb-2 text-text-primary dark:text-text-primary-dark">
                    E-posta
                </label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark focus:border-transparent" />
            </div>
            <div class="mb-4">
                <label
                    for="message"
                    class="block text-sm font-medium mb-2 text-text-primary dark:text-text-primary-dark">
                    Yorum
                </label>
                <textarea
                    id="message"
                    name="message"
                    rows="5"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary dark:focus:ring-primary-dark focus:border-transparent"></textarea>
            </div>

            <!-- Cloudflare Turnstile widget -->
            <div class="mb-4">
                <div
                    class="cf-turnstile"
                    data-sitekey="0x4AAAAAABF5KzbNxGlrw5_N"
                    data-theme="auto"
                    data-callback="onTurnstileSuccess"></div>
            </div>

            <button
                id="submit-comment"
                class="px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-md hover:bg-primary-dark dark:hover:bg-primary transition-colors">
                Gönder
            </button>
            <div id="comment-status" class="hidden mt-4 p-4 border rounded-md"></div>
        </div>
    </div>

    <!-- Yükleniyor Mesajı -->
    <div id="comment-loader" class="hidden mt-4 text-center">
        <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary dark:border-primary-dark"></div>
        <p class="mt-2 text-text-primary dark:text-text-primary-dark">Yorumunuz işleniyor...</p>
    </div>

    <!-- Yorum Formu JavaScript Kodu -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Cloudflare Turnstile script'ini dinamik olarak yükle
            const script = document.createElement("script");
            script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            const form = document.getElementById("comment-form");
            const submitButton = document.getElementById("submit-comment");
            const statusElement = document.getElementById("comment-status");
            const loaderElement = document.getElementById("comment-loader");
            const nameInput = document.getElementById("name");
            const emailInput = document.getElementById("email");
            const messageInput = document.getElementById("message");

            let turnstileToken = "";

            // Turnstile callback
            window.onTurnstileSuccess = function (token) {
                turnstileToken = token;
            };

            function showLoader() {
                loaderElement.classList.remove("hidden");
                submitButton.disabled = true;
                submitButton.classList.add("opacity-50", "cursor-not-allowed");
            }

            function hideLoader() {
                loaderElement.classList.add("hidden");
                submitButton.disabled = false;
                submitButton.classList.remove("opacity-50", "cursor-not-allowed");
            }

            function showConfirmation(message, isError = false) {
                statusElement.textContent = message;
                statusElement.classList.remove("hidden");

                // Sınıfları temizle
                statusElement.className = "mt-4 p-4 border rounded-md";

                if (isError) {
                    statusElement.classList.add(
                        "bg-red-50",
                        "dark:bg-red-900/20",
                        "text-red-800",
                        "dark:text-red-200",
                        "border-red-200",
                        "dark:border-red-800"
                    );
                } else {
                    statusElement.classList.add(
                        "bg-green-50",
                        "dark:bg-green-900/20",
                        "text-green-800",
                        "dark:text-green-200",
                        "border-green-200",
                        "dark:border-green-800"
                    );
                }
            }

            function resetInputData() {
                nameInput.value = "";
                emailInput.value = "";
                messageInput.value = "";

                // Turnstile'ı sıfırla
                if (window.turnstile) {
                    window.turnstile.reset();
                }
            }

            submitButton.addEventListener("click", async function (e) {
                e.preventDefault();

                // Form doğrulama
                if (!nameInput.value || !emailInput.value || !messageInput.value) {
                    showConfirmation("Lütfen tüm alanları doldurun.", true);
                    return;
                }

                // Turnstile doğrulama
                if (!turnstileToken) {
                    showConfirmation("Lütfen robot olmadığınızı doğrulayın.", true);
                    return;
                }

                // Slug'ı meta etiketinden veya URL'den al
                const slug =
                    document.querySelector('meta[name="slug"]')?.content ||
                    window.location.pathname.replace(/\/$/, "").split("/").pop();

                statusElement.classList.add("hidden");
                showLoader();

                try {
                    console.log("Sending request with data:", {
                        fields: {
                            slug: slug,
                            name: nameInput.value,
                            email: emailInput.value,
                            message: messageInput.value,
                        },
                        "cf-turnstile-response": turnstileToken,
                    });

                    const response = await fetch("https://comment-worker.ytoluyag.workers.dev/api/handle/form", {
                        method: "POST",
                        body: JSON.stringify({
                            fields: {
                                slug: slug,
                                name: nameInput.value,
                                email: emailInput.value,
                                message: messageInput.value,
                            },
                            "cf-turnstile-response": turnstileToken,
                        }),
                        headers: {
                            "Content-Type": "application/json",
                            Origin: "https://yuceltoluyag.dev",
                        },
                        mode: "cors",
                        credentials: "omit",
                    });

                    console.log("Response status:", response.status);
                    console.log("Response headers:", Object.fromEntries([...response.headers.entries()]));

                    let responseData;
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        responseData = await response.json();
                        console.log("Server JSON response:", responseData);
                    } else {
                        // JSON olmayan yanıtı metne dönüştür
                        const textResponse = await response.text();
                        console.log("Server text response:", textResponse);
                        responseData = { message: textResponse };
                    }

                    if (response.status === 200 || response.status === 201) {
                        resetInputData();
                        showConfirmation("Teşekkürler! Yorumunuz incelendikten sonra yayınlanacaktır.");
                    } else {
                        showConfirmation(
                            `Bir hata oluştu: ${responseData.message || response.statusText || "Bilinmeyen hata"}`,
                            true
                        );
                    }
                } catch (error) {
                    console.error("Error submitting comment:", error);
                    showConfirmation(`Yorumunuz gönderilirken bir hata oluştu: ${error.message}`, true);
                } finally {
                    hideLoader();
                }
            });
        });
    </script>
</section>
{% endif %}
