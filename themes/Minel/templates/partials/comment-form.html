{% if article %}
<section class="mt-8">
    <div class="bg-site-card rounded-lg overflow-hidden shadow-md">
        <div class="p-6 border-b border-border-card">
            <h2 class="text-2xl font-bold text-text-primary">Yorum Bırakın</h2>
            <p class="text-sm text-text-secondary mt-2">
                Yorumunuz incelendikten sonra yayınlanacaktır. E-posta adresiniz gizli tutulacak ve yayınlanmayacaktır.
            </p>
        </div>

        <div class="p-6">
            <form id="comment-form" class="space-y-5">
                <input id="fields_slug" name="options[slug]" type="hidden" value="{{ article.slug }}" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- İsim alanı -->
                    <div class="relative">
                        <label for="fields_name" class="block text-sm font-medium text-text-primary mb-1">
                            İsim
                            <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-3 py-2 border border-border-card rounded-lg bg-site-bg focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors text-text-primary placeholder-text-secondary/70"
                            id="fields_name"
                            name="fields[name]"
                            type="text"
                            placeholder="Adınız"
                            required />
                    </div>

                    <!-- E-posta alanı -->
                    <div class="relative">
                        <label for="fields_email" class="block text-sm font-medium text-text-primary mb-1">
                            E-posta
                            <span class="text-red-500">*</span>
                        </label>
                        <input
                            class="w-full px-3 py-2 border border-border-card rounded-lg bg-site-bg focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors text-text-primary placeholder-text-secondary/70"
                            id="fields_email"
                            name="fields[email]"
                            type="email"
                            placeholder="E-posta adresiniz"
                            required />
                        <p class="mt-1 text-xs text-text-secondary/80">E-posta adresiniz yayınlanmayacaktır</p>
                    </div>
                </div>

                <!-- Mesaj alanı -->
                <div class="relative">
                    <label for="fields_message" class="block text-sm font-medium text-text-primary mb-1">
                        Mesajınız
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <div
                            class="grid after:whitespace-pre-wrap after:invisible after:content-[attr(data-replicated-value)] after:[grid-area:1/1/2/2]"
                            data-replicated-value="">
                            <textarea
                                class="w-full p-3 border border-border-card rounded-lg bg-site-bg focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors text-text-primary placeholder-text-secondary/70 resize-none overflow-hidden [grid-area:1/1/2/2] min-h-[120px]"
                                id="fields_message"
                                name="fields[message]"
                                placeholder="Yorumunuzu buraya yazın..."
                                rows="4"
                                required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Cloudflare Turnstile widget -->
                <div
                    class="cf-turnstile mb-4"
                    data-sitekey="0x4AAAAAABF5KzbNxGlrw5_N"
                    data-callback="javascriptCallback"></div>

                <!-- Gönder butonu -->
                <div class="flex items-center justify-between">
                    <button
                        type="submit"
                        id="submit-comment"
                        class="relative px-6 py-3 rounded-lg bg-primary hover:bg-primary-dark text-white font-medium transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2">
                        Yorum Gönder
                    </button>
                </div>
            </form>

            <!-- Bildirim mesajı -->
            <div id="confirmation-message" class="mt-4 py-3 px-4 rounded-lg hidden"></div>
        </div>
    </div>
</section>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("comment-form");
        const confirmationMessage = document.getElementById("confirmation-message");
        let turnstileToken = "";

        // Turnstile callback
        window.javascriptCallback = function (token) {
            turnstileToken = token;
        };

        // Mesaj gösterme fonksiyonu
        function showMessage(message, type) {
            confirmationMessage.textContent = message;
            confirmationMessage.classList.remove(
                "hidden",
                "bg-green-100",
                "text-green-800",
                "bg-red-100",
                "text-red-800",
                "bg-blue-100",
                "text-blue-800"
            );

            if (type === "success") {
                confirmationMessage.classList.add("bg-green-100", "text-green-800");
            } else if (type === "error") {
                confirmationMessage.classList.add("bg-red-100", "text-red-800");
            } else if (type === "info") {
                confirmationMessage.classList.add("bg-blue-100", "text-blue-800");
            }
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const name = document.getElementById("fields_name").value;
            const email = document.getElementById("fields_email").value;
            const message = document.getElementById("fields_message").value;
            const slug = document.getElementById("fields_slug").value;

            if (name === "" || email === "" || message === "") {
                showMessage("Hata! Tüm gerekli alanları doldurduğunuzdan emin olun.", "error");
                return;
            }

            if (!turnstileToken) {
                showMessage("Lütfen robot olmadığınızı doğrulayın.", "error");
                return;
            }

            // Yükleniyor mesajı
            showMessage("Yorumunuz gönderiliyor...", "info");

            try {
                const response = await fetch("https://comment-worker.ytoluyag.workers.dev/api/handle/form", {
                    method: "POST",
                    body: JSON.stringify({
                        "cf-turnstile-response": turnstileToken,
                        fields: {
                            name,
                            email,
                            message,
                        },
                        options: {
                            slug,
                        },
                    }),
                    headers: { "Content-Type": "application/json" },
                });

                if (response.status === 200 || response.status === 201) {
                    // Form alanlarını temizle
                    form.reset();
                    // Turnstile'ı sıfırla
                    turnstile.reset();
                    turnstileToken = "";
                    showMessage("Teşekkürler! Yorumunuz incelendikten sonra yayınlanacaktır.", "success");
                } else {
                    const errorText = await response.text();
                    showMessage(`Bir şeyler yanlış gitti: ${errorText}`, "error");
                }
            } catch (error) {
                showMessage("Yorumunuz gönderilirken bir hata oluştu: " + error.message, "error");
            }
        });

        // Textarea otomatik yükseklik ayarlama
        const textarea = document.querySelector("textarea");
        textarea.addEventListener("input", function () {
            textarea.parentNode.dataset.replicatedValue = textarea.value;
        });
    });
</script>
{% endif %}
